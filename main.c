#include "stm32f10x.h"

int RCC_init (void);
void MCO_init (void);
void PWM_init (void);
void ADC_init (void);
void SysTick_init (void);

const int TimerTick = 10000;
volatile int res_1 = 0;
volatile int res_2 = 0;

int main()
{
	RCC_init ();
	MCO_init ();
	SysTick_init ();
	PWM_init ();
	ADC_init ();
	//TIM1 -> CR1 |= TIM_CR1_CEN; //single pulse
	while (1)
	{
		ADC1->CR2 |= ADC_CR2_JSWSTART; // ?????? ??????????????? ??????
		while(!(ADC1->SR & ADC_SR_EOC)); // ???????? ?????????? ??????????????
		ADC1->SR &= ~ADC_SR_EOC;
		res_1 = (int)ADC1 -> JDR1; //
		res_2 = (int)ADC1 -> JDR2; //
		
		for (int i = 1; i < 10000; i++); // ????????
	}
}

int RCC_init (void)
{
	/* Reset HSEON, CSSON and PLLON bits */
	RCC->CR &= (uint32_t)0xFEF6FFFF;
	
	RCC -> CR |= RCC_CR_HSEON; // ???????? ????????? HSE.
	while (!((RCC -> CR) & RCC_CR_HSERDY)); // ???????? ?????????? HSE.
	RCC -> CFGR &= ~RCC_CFGR_SW; // ???????? ???? SW0, SW1.
	RCC -> CFGR |= RCC_CFGR_SW_HSE; // ??????? HSE ??? ???????????? SW0=1.	
	
	FLASH->ACR |= FLASH_ACR_PRFTBE; // Enable Prefetch Buffer.
	FLASH->ACR &= ~FLASH_ACR_LATENCY; // ???????????.
	FLASH->ACR |= FLASH_ACR_LATENCY_2; // ???? 48< SystemCoreClock <= 72, ?????????? 2 ?????.
	
	RCC -> CFGR &= ~((RCC_CFGR_PLLSRC|RCC_CFGR_PLLXTPRE|RCC_CFGR_PLLMULL)); // ???????????.
	RCC -> CFGR |= RCC_CFGR_PLLSRC_HSE; // ??????????? PLL ?? HSE (8 MHz).
	RCC -> CFGR |= RCC_CFGR_PLLMULL9; // ???????? ??????? ?? 9 (8*9=72 MHz).
	RCC -> CR |= RCC_CR_PLLON; // ????????? PLL.
	while ((RCC->CR & RCC_CR_PLLRDY)==0) {} // ???????? ?????????? PLL.
	RCC -> CFGR &= ~RCC_CFGR_SW; // ???????? ???? SW0, SW1.
	RCC -> CFGR |= RCC_CFGR_SW_PLL; // ???????????? ? ?????? PLL.
	while (((RCC -> CFGR) & RCC_CFGR_SWS) != 0x08) {} // ???????? ???????????? ?? PLL.
	return 0;
}

void MCO_init (void)
{
	RCC -> APB2ENR 	|= RCC_APB2ENR_IOPAEN;		// ?????? ???????????? ?? ????
 
	GPIOA -> CRH	&= ~GPIO_CRH_CNF8;		// ?????????? ???? CNF ??? ???? 8. ????? 00 - Push-Pull 
	GPIOA -> CRH	|= GPIO_CRH_CNF8_1;		// ?????? ????? ??? 8 ?? ???? ????? CNF  = 10 (?????????????? ???????, Push-Pull)
 
	GPIOA -> CRH	&= ~GPIO_CRH_MODE8;				// ?????????? ???? MODE ??? ???? 8
	GPIOA -> CRH	|= (GPIO_CRH_MODE8_1 | GPIO_CRH_MODE8_0);	// ?????????? ??? MODE ??? ?????? ????. ????? MODE11 = Max Speed 50MHz
 
	RCC -> CFGR	&= ~RCC_CFGR_MCO;		// ???????? MCO
	RCC -> CFGR	|= RCC_CFGR_MCO_PLL;		// ????????? ??? MCO ?????? ? PLL/2
	//RCC -> CFGR	|= RCC_CFGR_MCO_SYSCLK;		// ?????????? ??? ??? ?????? ? SYSCLK
}

void PWM_init (void)
{
	// ????????????  GPIOA , TIM1, ?????????????? ??????? ?????
	RCC -> APB2ENR |= (RCC_APB2ENR_IOPAEN | RCC_APB2ENR_TIM1EN | RCC_APB2ENR_AFIOEN);
        
    //PA11 push-pull
	GPIOA -> CRH &= ~GPIO_CRH_CNF11; // ???????????.
	GPIOA -> CRH |= GPIO_CRH_CNF11_1;

	GPIOA -> CRH &= ~GPIO_CRH_MODE11; // ???????????.
	GPIOA -> CRH |= (GPIO_CRH_MODE11_1 | GPIO_CRH_MODE11_0); //????? MODE11 = Max Speed 50MHz
	
	//100 kHz, ????. ?????????? 0,5
	//????????
	TIM1 -> PSC = 72 - 1;
	//???????? ????????????
	TIM1 -> ARR = 10 - 1;
	//????. ??????????
	TIM1 -> CCR4 = 5;
	
	//???????? ?? ????? ????? 4, ???????? ??????? ??????? 
	TIM1 -> CCER |= (TIM_CCER_CC4E | TIM_CCER_CC4P);
	//???????? ???????????? ?????? ??????? ??? ??????
	TIM1 -> BDTR |= TIM_BDTR_MOE;
	//PWM mode 1, ?????? ??? 4 ?????
	TIM1 -> CCMR2 = ((TIM_CCMR2_OC4M_2 | TIM_CCMR2_OC4M_1) & (~TIM_CCMR2_OC4M_0));
    //???? ???? ????????? ?????? ?????, ??? ????? ??????? ???
    //TIM1->CCMR1 = TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1;
	//??????? ?????
	TIM1 -> CR1 &= ~TIM_CR1_DIR;
	//???????????? ?? ??????, Fast PWM
	TIM1 -> CR1 &= ~TIM_CR1_CMS;
	TIM1 -> CR1 |= TIM_CR1_OPM;
	//???????? ???????

}

void ADC_init (void)
{
	GPIOA -> CRL &= ~(GPIO_CRL_MODE3 | GPIO_CRL_CNF3); // PA3 - ?????????? ????
	GPIOA -> CRL &= ~ (GPIO_CRL_MODE0 | GPIO_CRL_CNF0); // PA0 - ?????????? ????
	
	RCC -> APB2ENR |= RCC_APB2ENR_ADC1EN; // ?????????? ???????????? ???
	RCC -> CFGR &= ~RCC_CFGR_ADCPRE_0;  // ???????????? ??? = 10 (/6)
	RCC -> CFGR |=  RCC_CFGR_ADCPRE_1;
	
	ADC1 -> CR1 = 0;      // ????????? ??? ? ??????????? ?????????
	ADC1 -> CR2 = 0;
	
	ADC1 -> SMPR2 &= ~(ADC_SMPR2_SMP0_0 | ADC_SMPR2_SMP0_1 | ADC_SMPR2_SMP0_2); // ????? ??????? 1,5 ?????
	ADC1 -> SMPR2 &= ~(ADC_SMPR2_SMP3_0 | ADC_SMPR2_SMP3_1 | ADC_SMPR2_SMP3_2); // ????? ??????? 1,5 ?????
	
	//????????? ??????????????? ???????
	ADC1 -> JSQR = 0; //???????
	ADC1 -> JSQR |= ADC_JSQR_JL_0; // 2 ??????????????
	ADC1 -> JSQR |= ADC_JSQR_JSQ1_0; // 1? ?????????????? - ????? 0
	ADC1 -> JSQR |= (ADC_JSQR_JSQ4_0 | ADC_JSQR_JSQ4_1); // 2? ?????????????? - ????? 3*/
	
	//ADC1 -> JSQR = 3279937;
	
	ADC1->CR2 &= ~ADC_CR2_CONT; // ?????? ???????????? ??????
	ADC1->CR1 |= ADC_CR1_SCAN; //????? ????????????
	
	ADC1->CR2 |= ADC_CR2_JEXTSEL; // ???????? ??????? - JSWSTART
	ADC1->CR2 |= ADC_CR2_JEXTTRIG; // ?????????? ???????? ??????? ??? ??????????????? ???????
	
	// ??????????
	ADC1 -> CR2 |= ADC_CR2_ADON; // ????????? ???
	for (int i = 1; i < 10000; i++); // ????????
	ADC1->CR2 |= ADC_CR2_CAL; // ?????? ??????????
	while (((ADC1 -> CR2) & ADC_CR2_CAL) != 0); // ???????? ????????? ??????????
	//ADC1->CR2 &= ~ADC_CR2_ADON; // ????????? ???
}

void SysTick_init (void)
{
	SysTick -> LOAD = TimerTick;
	SysTick -> VAL = TimerTick;
	SysTick -> CTRL = SysTick_CTRL_CLKSOURCE_Msk | SysTick_CTRL_TICKINT_Msk | SysTick_CTRL_ENABLE_Msk;
}

void SysTick_Handler(void)
{
	TIM1 -> CR1 |= TIM_CR1_CEN; //single pulse
}
